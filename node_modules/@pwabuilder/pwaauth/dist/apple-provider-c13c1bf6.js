class e{constructor(e,t){this.clientId=e,this.redirectUri=t}signIn(){return this.loadDependencies().then(()=>this.signInWithApple())}loadDependencies(){return this.appendAppleScript().then(()=>this.initAuth())}appendAppleScript(){return this.getAppleJS()?Promise.resolve():new Promise((t,r)=>{const n=window.document.createElement("script");n.async=!0,n.src=e.scriptUrl,n.onload=()=>t(),n.onerror=e=>r({message:"Error loading Apple JS",error:e}),window.document.head.appendChild(n)})}initAuth(){const e=this.getAppleJS();return e?(e.auth.init({clientId:this.clientId,scope:"name email",redirectURI:this.redirectUri||this.trimSlash(location.href),state:"",usePopup:!0}),Promise.resolve()):Promise.reject("AppleJS not loaded")}signInWithApple(){const e=this.getAppleJS();return e?e.auth.signIn().then(e=>this.getSignInResult(e)):Promise.reject("AppleJS not loaded")}getAppleJS(){return window.AppleID}getSignInResult(e){var t;if(this.isErrorResult(e))return{error:new Error(e.error),provider:"Apple"};const r=this.decodeUserDetails(e);return{email:r.email,name:r.name,accessToken:null===(t=null==e?void 0:e.authorization)||void 0===t?void 0:t.code,accessTokenExpiration:r.appleToken?new Date(1e3*r.appleToken.exp):null,imageUrl:null,providerData:e,provider:"Apple",error:null}}isErrorResult(e){return!!e.error}decodeUserDetails(e){const t=this.decodeJwt(e.authorization.id_token),r=null==t?void 0:t.email;if(!r)throw new Error("Unable to decode user's email from JWT token: "+e.authorization.id_token);let n=null;return e.user&&e.user.name?(n=[e.user.name.firstName,e.user.name.lastName].filter(e=>!!e).join(" "),this.tryStoreNameWithEmail(n,r)):n=this.tryGetStoredNameFromEmail(r),n||(n=""),{name:n,email:r,appleToken:t}}decodeJwt(e){const t=e.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),r=decodeURIComponent(atob(t).split("").map((function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)})).join(""));return JSON.parse(r)}tryGetStoredNameFromEmail(e){const t=this.getUserNameLocalStorageKey(e);try{return localStorage.getItem(t)}catch(e){return console.warn("Error fetching user from local storage.",t,e),null}}tryStoreNameWithEmail(e,t){const r=this.getUserNameLocalStorageKey(t);try{localStorage.setItem(r,e)}catch(t){console.warn("Error storing user name in local storage. Subsequent sign-ins may not have a user name.",r,e,t)}}getUserNameLocalStorageKey(t){return`${e.nameLocalStorageKeyPrefix}-${t}`}trimSlash(e){let t=0;for(let r=e.length-1;r>=0;r--)if("/"!==e[r]){t=r+1;break}return e.substr(0,t)}}e.scriptUrl="https://appleid.cdn-apple.com/appleauth/static/jsapi/appleid/1/en_US/appleid.auth.js",e.nameLocalStorageKeyPrefix="pwa-auth-apple-email";export{e as AppleProvider};
